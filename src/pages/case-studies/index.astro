---
import BaseLayout from "../../layouts/BaseLayout.astro";
import CaseStudyCard from "../../components/CaseStudyCard.astro";
import TagPill from "../../components/TagPill.astro";
import { getCaseStudies } from "../../data/caseStudies";

const caseStudies = getCaseStudies();
const tags = [...new Set(caseStudies.flatMap((item) => item.tags))].sort(
  (a, b) => a.localeCompare(b),
);
---

<BaseLayout
  pageTitle="Case Studies"
  description="Outcome-focused examples from analytics consulting delivery."
>
  <h1>Case Studies</h1>
  <p class="lead">
    Filter by topic to scan outcomes, approach, and delivery context.
  </p>

  <div
    class="tag-pills filter-row"
    role="toolbar"
    aria-label="Filter case studies by tag"
  >
    <TagPill label="All" value="all" asButton active />
    {
      tags.map((tag) => (
        <TagPill label={tag} value={tag.toLowerCase()} asButton />
      ))
    }
  </div>

  <div id="case-study-grid" class="grid cards section">
    {
      caseStudies.map((item) => (
        <div
          data-case-study
          data-tags={item.tags.map((tag) => tag.toLowerCase()).join("|")}
        >
          <CaseStudyCard {...item} />
        </div>
      ))
    }
  </div>

  <script is:inline>
    const buttons = Array.from(document.querySelectorAll("button[data-tag]"));
    const cards = Array.from(document.querySelectorAll("[data-case-study]"));

    const setFilter = (tag) => {
      buttons.forEach((button) => {
        button.classList.toggle("is-active", button.dataset.tag === tag);
      });

      cards.forEach((card) => {
        const rawTags = card.getAttribute("data-tags") ?? "";
        const hasTag = rawTags.split("|").includes(tag);
        const shouldShow = tag === "all" || hasTag;
        card.classList.toggle("is-hidden", !shouldShow);
      });
    };

    buttons.forEach((button) => {
      button.addEventListener("click", () =>
        setFilter(button.dataset.tag ?? "all"),
      );
    });
  </script>
</BaseLayout>
